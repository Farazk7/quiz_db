<!DOCTYPE html>
<html>
<head>
    <title>Take Quiz</title>
</head>
<body>

<h2 id="quizTitle"></h2>
<div id="questions"></div>

<button onclick="submitAttempt()">Submit Quiz</button>

<script>
    const params = new URLSearchParams(window.location.search);
    const quizId = params.get("quizId");
    let answers = [];

    async function loadQuiz() {
        const res = await fetch("/api/public/quizzes/" + quizId);
        const quiz = await res.json();

        document.getElementById("quizTitle").innerText = quiz.title;

        let html = "";

        quiz.questions.forEach(q => {
            if (q.type === "TEXT") {
                html += `<p>${q.text}</p>
                         <input type="text" id="q_${q.id}" />`;
            }

            if (q.type === "TRUE_FALSE") {
                html += `<p>${q.text}</p>
                         <label><input type="radio" name="q_${q.id}" value="true"> True</label>
                         <label><input type="radio" name="q_${q.id}" value="false"> False</label>`;
            }

            if (q.type === "MCQ") {
                html += `<p>${q.text}</p>`;
                q.choices.forEach(choice => {
                    html += `<label>
                              <input type="radio" name="q_${q.id}" value="${choice.id}">
                              ${choice.text}
                             </label><br>`;
                });
            }

            html += "<hr>";
        });

        document.getElementById("questions").innerHTML = html;
    }

    async function submitAttempt() {
        document.querySelectorAll("input").forEach(input => {
            if (input.type === "text" && input.value.trim() !== "") {
                answers.push({ questionId: input.id.split("_")[1], textAnswer: input.value });
            }
        });

        document.querySelectorAll("input[type=radio]:checked").forEach(input => {
            answers.push({ questionId: input.name.split("_")[1], selectedChoiceId: input.value });
        });

        const payload = {
            quizId: Number(quizId),
            participantName: "User",
            answers: answers
        };

        const res = await fetch("/api/public/quizzes/attempt", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(payload)
        });

        const result = await res.json();
        localStorage.setItem("quizResult", JSON.stringify(result));
        window.location.href = "/ui/quiz-result.html";
    }

    loadQuiz();
</script>

</body>
</html>
